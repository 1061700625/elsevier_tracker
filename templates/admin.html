{% extends "base.html" %}

{% block title %}管理员后台{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <h3 class="mb-4">
      管理员后台
      {% if is_admin %}
      <a href="{{ url_for('admin_logout') }}" class="btn btn-sm btn-outline-light ms-3">退出</a>
      {% endif %}
    </h3>

    {% if not is_admin %}
    <div class="card">
      <div class="card-body">
        <form method="post">
          <div class="mb-3">
            <label for="password" class="form-label">管理员密码</label>
            <input type="password" class="form-control" id="password" name="password" required />
          </div>
          <button type="submit" class="btn btn-primary">登录</button>
        </form>
      </div>
    </div>
    {% else %}

    <div class="alert alert-secondary">
      <div><strong>下一次定时检查：</strong>{{ next_run_time or '未知' }}</div>
      <div class="text-muted">说明：后台会分别轮询 Submission 与 Article 两类任务。</div>
    </div>

    <!-- ===================== Submission tasks ===================== -->
    <h5 class="mt-4">Submission 任务</h5>
    {% if tasks and tasks|length > 0 %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>UUID</th>
            <th>当前状态</th>
            <th>通知方式</th>
            <th>联系方式</th>
            <th>创建时间</th>
            <th>最近检查</th>
            <th>错误</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tasks %}
          <tr>
            <td><a href="{{ url_for('query', uuid=t.uuid) }}">{{ t.uuid }}</a></td>
            <td>
              {% if t.last_status is not none %}
                <span class="badge bg-info text-dark">{{ status_map.get(t.last_status) or ('状态 ' ~ t.last_status) }}</span>
                <small class="text-muted ms-1">({{ t.last_status }})</small>
                {% if t.event_counts %}
                  <div class="small text-muted">
                    邀请 {{ t.event_counts.get('REVIEWER_INVITED', 0) }},
                    接受 {{ t.event_counts.get('REVIEWER_ACCEPTED', 0) }},
                    完成 {{ t.event_counts.get('REVIEWER_COMPLETED', 0) }}
                  </div>
                {% endif %}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>{{ '邮箱' if t.notify_type == 'email' else 'QQ' }}</td>
            <td>{{ t.contact }}</td>
            <td>{{ t.created_at }}</td>
            <td>{{ t.last_checked_at or '-' }}</td>
            <td>
              {% if t.last_error %}
                <span class="text-danger">{{ t.last_error }}</span>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              <button type="button" class="btn btn-sm btn-danger"
                      onclick="openDeleteModal('submission', '{{ t.uuid }}')">
                删除
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="alert alert-info">当前没有任何 Submission 监控任务。</div>
    {% endif %}

    <!-- ===================== Article tasks ===================== -->
    <h5 class="mt-4">Article 任务</h5>
    {% if article_tasks and article_tasks|length > 0 %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Article Key</th>
            <th>aid/jid/surname</th>
            <th>通知方式</th>
            <th>联系方式</th>
            <th>创建时间</th>
            <th>最近检查</th>
            <th>错误</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for a in article_tasks %}
          <tr>
            <td><a href="{{ url_for('query', article_key=a.article_key) }}">{{ a.article_key }}</a></td>
            <td>{{ a.aid }}/{{ a.jid }}/{{ a.surname }}</td>
            <td>{{ '邮箱' if a.notify_type == 'email' else 'QQ' }}</td>
            <td>{{ a.contact }}</td>
            <td>{{ a.created_at }}</td>
            <td>{{ a.last_checked_at or '-' }}</td>
            <td>
              {% if a.last_error %}
                <span class="text-danger">{{ a.last_error }}</span>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>
              <button type="button" class="btn btn-sm btn-danger"
                      onclick="openDeleteModal('article', '{{ a.article_key }}')">
                删除
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="alert alert-info">当前没有任何 Article 监控任务。</div>
    {% endif %}

    {% endif %}
  </div>
</div>

<!-- 删除确认弹框（Submission/Article 通用） -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">确认删除任务</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>您确定要删除 <strong id="deleteTaskText"></strong> 的监控任务吗？</p>

        <div class="mb-3">
          <label for="deleteReason" class="form-label">删除理由（将发送给用户，可不填）</label>
          <textarea class="form-control" id="deleteReason" rows="3"
                    placeholder="请输入删除此监控任务的理由..."></textarea>
        </div>

        <div class="alert alert-warning mb-0">
          注意：删除操作将停止对该任务的监控。
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <form method="post" id="deleteForm">
          <input type="hidden" name="delete_by" value="admin" />
          <input type="hidden" name="delete_reason" id="deleteReasonInput" />
          <button type="submit" class="btn btn-danger">确认删除</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function openDeleteModal(taskType, taskId) {
    const taskText = (taskType === 'article')
      ? ('Article: ' + taskId)
      : ('UUID: ' + taskId);

    document.getElementById('deleteTaskText').innerText = taskText;

    const subActionTpl = "{{ url_for('delete', uuid='__ID__') }}";
    const artActionTpl = "{{ url_for('delete_article', article_key='__ID__') }}";
    const action = (taskType === 'article')
      ? artActionTpl.replace('__ID__', taskId)
      : subActionTpl.replace('__ID__', taskId);

    document.getElementById('deleteForm').action = action;

    document.getElementById('deleteReason').value = '';
    document.getElementById('deleteReasonInput').value = '';

    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
  }

  document.getElementById('deleteReason').addEventListener('input', function(){
    document.getElementById('deleteReasonInput').value = this.value;
  });
</script>

{% endblock %}
