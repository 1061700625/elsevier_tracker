{% extends "base.html" %}

{% block title %}æäº¤ç›‘æ§ä»»åŠ¡{% endblock %}

{% block content %}

<!-- è¯´æ˜éƒ¨åˆ†ï¼š100% å…¨å®½ï¼ˆä¿ç•™åŸæœ‰è¯´æ˜ï¼Œå¹¶è¡¥å…… Article è¯´æ˜ï¼‰ -->
<div class="row mb-4">
  <div class="col-12">
    <div class="alert alert-info" style="line-height: 1.6; font-size: 1rem;">
      <h4 class="fw-bold mb-3">ğŸ“˜ ç³»ç»Ÿè¯´æ˜</h4>
      <p>
        æœ¬ç³»ç»Ÿç”¨äº <strong>è‡ªåŠ¨ç›‘æ§ç¨¿ä»¶ï¼ˆManuscriptï¼‰åœ¨å®¡ç¨¿ç³»ç»Ÿä¸­çš„çŠ¶æ€å˜åŒ–</strong>ã€‚
        æäº¤ç¨¿ä»¶çš„ UUID åï¼Œç³»ç»Ÿä¼šå®šæœŸæ£€æŸ¥çŠ¶æ€ï¼Œå¹¶åœ¨å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨é€šçŸ¥æ‚¨ã€‚
      </p>

      <h5 class="fw-bold mt-4">ğŸ”§ ä½¿ç”¨æ–¹å¼ï¼ˆSubmission ç›‘æ§ï¼‰</h5>
      <ul>
        <li>å¡«å†™ç¨¿ä»¶ UUIDï¼ˆå®¡ç¨¿ç³»ç»Ÿæä¾›çš„å”¯ä¸€æ ‡è¯†ï¼‰</li>
        <li>é€‰æ‹©é€šçŸ¥æ–¹å¼ï¼ˆé‚®ç®± / QQï¼‰</li>
        <li>å¡«å†™å¯¹åº”çš„è”ç³»æ–¹å¼ï¼ˆé‚®ç®±åœ°å€æˆ– QQ å·ï¼‰</li>
        <li>(è‹¥è¦ä½¿ç”¨QQæ–¹å¼ï¼Œè¯·è¿›Qç¾¤å’¨è¯¢ç¾¤ä¸»ï¼š768030842)</li>
        <li>æäº¤åç³»ç»Ÿå°†è‡ªåŠ¨å¼€å§‹åå°ç›‘æ§</li>
        <li>çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ç³»ç»Ÿä¼šè‡ªåŠ¨å‘é€æé†’</li>
        <li>æ‚¨ä¹Ÿå¯éšæ—¶å‰å¾€â€œæŸ¥è¯¢é¡µé¢â€æŸ¥çœ‹å½“å‰çŠ¶æ€</li>
        <li>é¡¹ç›®å·²å¼€æºï¼šhttps://github.com/1061700625/elsevier_tracker</li>
        <li>æ³¨ï¼šè¯·ç¡®ä¿uuidåœ¨ç½‘é¡µå¯æ˜¾ç¤º https://track.authorhub.elsevier.com/?uuid=xxx</li>
      </ul>

      <h5 class="fw-bold mt-4">ğŸ“° Article ç›‘æ§ï¼ˆç”Ÿäº§è¿›åº¦ï¼‰</h5>
      <ul class="mb-0">
        <li>åˆ‡æ¢åˆ°ä¸‹æ–¹ <strong>â€œArticle ç›‘æ§â€</strong> æ ‡ç­¾é¡µ</li>
        <li>å¯ç›´æ¥ç²˜è´´ä½œè€…è¿½è¸ªé¡µ URLï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£æå…¶ä¸­çš„ <code>aid / jid / surname</code> å¹¶å¡«å……ï¼›ä¹Ÿå¯æ‰‹å·¥å¡«å†™</li>
        <li>URL ç¤ºä¾‹ï¼š<code>https://authors.elsevier.com/tracking/article/details.do?aid=108030&jid=NN&surname=Song</code></li>
        <li>ç³»ç»Ÿä¼šç›‘æ§ï¼š<code>LastUpdatedDate</code>ã€<code>Status comment</code>ã€<code>Production events</code> çš„å˜åŒ–</li>
      </ul>

      <h5 class="fw-bold mt-4">ğŸ”’ éšç§è¯´æ˜</h5>
      <p class="mb-0">ç³»ç»Ÿä¸ä¼šä¿å­˜ä»»ä½•ç¨¿ä»¶å†…å®¹ï¼Œä»…ä¿å­˜å¿…è¦çš„ä¿¡æ¯ç”¨äºç›‘æ§ä¸é€šçŸ¥ã€‚</p>
    </div>
  </div>
</div>

<!-- æäº¤éƒ¨åˆ†ï¼š100% å…¨å®½ -->
<div class="row">
  <div class="col-12">

    <h3 class="mt-2">æäº¤ç›‘æ§ä»»åŠ¡</h3>

    <div class="card mt-3 p-4">

      <ul class="nav nav-tabs" id="taskTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="sub-tab" data-bs-toggle="tab" data-bs-target="#sub-pane" type="button" role="tab">
            Submission ç›‘æ§
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="art-tab" data-bs-toggle="tab" data-bs-target="#art-pane" type="button" role="tab">
            Article ç›‘æ§
          </button>
        </li>
      </ul>

      <div class="tab-content border border-top-0 rounded-bottom p-3" id="taskTabsContent">
        <!-- ===================== Submission ===================== -->
        <div class="tab-pane fade show active" id="sub-pane" role="tabpanel" aria-labelledby="sub-tab">
          <form method="post" class="mt-2" id="submissionForm">
            <input type="hidden" name="task_type" value="submission" />

            <div class="mb-3">
              <label class="form-label">UUIDï¼ˆæˆ–åŒ…å« uuid=... çš„é“¾æ¥ï¼‰</label>
              <input
                type="text"
                class="form-control"
                name="uuid"
                id="sub_uuid"
                placeholder="ä¾‹å¦‚ï¼šxxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx æˆ– tracking é“¾æ¥"
                required
              />
              <div class="form-text">ç³»ç»Ÿä¼šè‡ªåŠ¨ä»é“¾æ¥/æ–‡æœ¬ä¸­æå– uuidã€‚</div>
            </div>

            <div class="mb-3">
              <label class="form-label d-block">é€šçŸ¥æ–¹å¼</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="notify_type" id="sub_notify_email" value="email" required />
                <label class="form-check-label" for="sub_notify_email">é‚®ç®±</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="notify_type" id="sub_notify_qq" value="qq" required />
                <label class="form-check-label" for="sub_notify_qq">QQ</label>
              </div>
            </div>

            <div class="mb-3">
              <label for="sub_contact" class="form-label">è”ç³»æ–¹å¼</label>
              <input
                type="text"
                class="form-control"
                id="sub_contact"
                name="contact"
                placeholder="é‚®ç®±åœ°å€æˆ– QQ å·"
                required
              />
            </div>

            <div class="d-flex gap-2">
              <button type="button" id="sub_test_btn" class="btn btn-info">æµ‹è¯•å‘é€</button>
              <button type="submit" class="btn btn-primary">æäº¤/æ›´æ–°</button>
            </div>
          </form>
        </div>

        <!-- ===================== Article ===================== -->
        <div class="tab-pane fade" id="art-pane" role="tabpanel" aria-labelledby="art-tab">
          <form method="post" class="mt-2" id="articleForm">
            <input type="hidden" name="task_type" value="article" />

            <div class="mb-3">
              <label class="form-label">Article è¿½è¸ª URLï¼ˆå¯é€‰ï¼‰</label>
              <input
                type="text"
                class="form-control"
                name="article_url"
                id="art_url"
                placeholder="https://authors.elsevier.com/tracking/article/details.do?aid=...&jid=...&surname=..."
              />
              <div class="form-text">è‹¥ç²˜è´´ URLï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£æå¹¶å¡«å…… aid/jid/surnameï¼›ä¹Ÿå¯æ‰‹åŠ¨å¡«å†™ä¸‰é¡¹å‚æ•°ã€‚</div>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">aid</label>
                <input type="text" class="form-control" name="aid" id="art_aid" placeholder="ä¾‹å¦‚ï¼š108030" />
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">jid</label>
                <input type="text" class="form-control" name="jid" id="art_jid" placeholder="ä¾‹å¦‚ï¼šNN" />
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">surname</label>
                <input type="text" class="form-control" name="surname" id="art_surname" placeholder="ä¾‹å¦‚ï¼šSong" />
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label d-block">é€šçŸ¥æ–¹å¼</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="notify_type" id="art_notify_email" value="email" required />
                <label class="form-check-label" for="art_notify_email">é‚®ç®±</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="notify_type" id="art_notify_qq" value="qq" required />
                <label class="form-check-label" for="art_notify_qq">QQ</label>
              </div>
            </div>

            <div class="mb-3">
              <label for="art_contact" class="form-label">è”ç³»æ–¹å¼</label>
              <input
                type="text"
                class="form-control"
                id="art_contact"
                name="contact"
                placeholder="é‚®ç®±åœ°å€æˆ– QQ å·"
                required
              />
            </div>

            <div class="d-flex gap-2">
              <button type="button" id="art_test_btn" class="btn btn-info">æµ‹è¯•å‘é€</button>
              <button type="submit" class="btn btn-primary">æäº¤/æ›´æ–°</button>
            </div>
          </form>
        </div>
      </div>

      <!-- æµ‹è¯•é€šçŸ¥çš„éšè—è¡¨å•ï¼ˆå¤ç”¨åç«¯ /test_notifyï¼‰ -->
      <form id="testForm" method="post" action="{{ url_for('test_notify') }}" style="display: none;">
        <input type="hidden" name="task_type" id="test_task_type">
        <input type="hidden" name="uuid" id="test_uuid">
        <input type="hidden" name="article_url" id="test_article_url">
        <input type="hidden" name="aid" id="test_aid">
        <input type="hidden" name="jid" id="test_jid">
        <input type="hidden" name="surname" id="test_surname">
        <input type="hidden" name="notify_type" id="test_notify_type">
        <input type="hidden" name="contact" id="test_contact">
      </form>

    </div>

  </div>
</div>

<!-- åº•éƒ¨ç»Ÿè®¡å›¾ï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰ -->
<div class="row mt-5">
  <div class="col-12">
    <div style="display: flex; justify-content: center; align-items: center;">
      <img src="https://count.getloli.com/@elsevier_tracker" alt="elsevier_tracker" />
    </div>
  </div>
</div>

<script>
(function(){
  function parseQuery(url) {
    try {
      const u = new URL(url);
      return {
        aid: u.searchParams.get('aid') || '',
        jid: u.searchParams.get('jid') || '',
        surname: u.searchParams.get('surname') || '',
      };
    } catch (e) {
      return {aid:'', jid:'', surname:''};
    }
  }

  // è‡ªåŠ¨è§£æ article URLï¼ˆinput/blur éƒ½å°è¯•ï¼‰
  const artUrl = document.getElementById('art_url');
  function tryFillFromUrl(){
    const v = (artUrl.value || '').trim();
    if(!v) return;
    const p = parseQuery(v);
    if(p.aid) document.getElementById('art_aid').value = p.aid;
    if(p.jid) document.getElementById('art_jid').value = p.jid;
    if(p.surname) document.getElementById('art_surname').value = p.surname;
  }
  artUrl.addEventListener('input', tryFillFromUrl);
  artUrl.addEventListener('blur', tryFillFromUrl);
  artUrl.addEventListener('change', tryFillFromUrl);

  function sendTest(payload){
    // ç®€å•æ ¡éªŒï¼ˆé¿å…ç©ºæäº¤ï¼‰
    if(payload.task_type === 'submission'){
      if(!payload.uuid){ alert('è¯·å¡«å†™ UUID'); return; }
    } else if(payload.task_type === 'article'){
      if(!(payload.article_url || (payload.aid && payload.jid && payload.surname))){
        alert('è¯·æä¾› Article URLï¼Œæˆ–åˆ†åˆ«å¡«å†™ aid / jid / surname'); return;
      }
    }
    if(!payload.notify_type){ alert('è¯·é€‰æ‹©é€šçŸ¥æ–¹å¼'); return; }
    if(!payload.contact){ alert('è¯·å¡«å†™è”ç³»æ–¹å¼'); return; }

    if (!confirm('æ˜¯å¦è¦å‘é€æµ‹è¯•é€šçŸ¥ï¼Ÿç³»ç»Ÿå°†ç«‹å³å‘é€ä¸€æ¡æµ‹è¯•æ¶ˆæ¯åˆ°æ‚¨æŒ‡å®šçš„é‚®ç®±æˆ–QQã€‚')) return;

    document.getElementById('test_task_type').value = payload.task_type || '';
    document.getElementById('test_uuid').value = payload.uuid || '';
    document.getElementById('test_article_url').value = payload.article_url || '';
    document.getElementById('test_aid').value = payload.aid || '';
    document.getElementById('test_jid').value = payload.jid || '';
    document.getElementById('test_surname').value = payload.surname || '';
    document.getElementById('test_notify_type').value = payload.notify_type || '';
    document.getElementById('test_contact').value = payload.contact || '';
    document.getElementById('testForm').submit();
  }

  // Submission test
  document.getElementById('sub_test_btn').addEventListener('click', function(e){
    e.preventDefault();
    const notifyRadio = document.querySelector('#sub-pane input[name="notify_type"]:checked');
    sendTest({
      task_type: 'submission',
      uuid: document.getElementById('sub_uuid').value.trim(),
      notify_type: notifyRadio ? notifyRadio.value : '',
      contact: document.getElementById('sub_contact').value.trim(),
    });
  });

  // Article test
  document.getElementById('art_test_btn').addEventListener('click', function(e){
    e.preventDefault();
    const notifyRadio = document.querySelector('#art-pane input[name="notify_type"]:checked');
    sendTest({
      task_type: 'article',
      article_url: document.getElementById('art_url').value.trim(),
      aid: document.getElementById('art_aid').value.trim(),
      jid: document.getElementById('art_jid').value.trim(),
      surname: document.getElementById('art_surname').value.trim(),
      notify_type: notifyRadio ? notifyRadio.value : '',
      contact: document.getElementById('art_contact').value.trim(),
    });
  });

})();
</script>

{% endblock %}
